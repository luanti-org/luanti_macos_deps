name: macos_deps

on:
  - push
  - pull_request

jobs:
  build_macos_deps:
    runs-on: macos-15
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Prepare
        run: |
          source sdk.sh
          echo "REPDIR=$(pwd)" >> $GITHUB_ENV
          brew install nasm m4 autoconf automake libtool
          install_sdk 11.3

      - name: Download/clone sources
        run: |
          source deps.sh
          source angle.sh
          mkdir $REPDIR/sources
          cd $REPDIR/sources
          download_macos_deps
          clone_macos_angle $REPDIR/data

      - name: Build deps for arm64
        run: |
          source deps.sh
          mkdir $REPDIR/arm64_deps
          cd $REPDIR/arm64_deps
          untar_macos_deps $REPDIR/sources
          build_macos_deps arm64 11.2 16.2 $REPDIR/macos_arm64_deps

      - name: Build ANGLE for arm64
        run: |
          source angle.sh
          cd $REPDIR/sources
          build_macos_angle arm64 11.2 16.2 $REPDIR/macos_arm64_deps $REPDIR/data

      - name: Build deps for x86_64
        run: |
          source deps.sh
          mkdir $REPDIR/x86_64_deps
          cd $REPDIR/x86_64_deps
          untar_macos_deps $REPDIR/sources
          build_macos_deps x86_64 11.2 16.2 $REPDIR/macos_x86_64_deps

      - name: Create archive from arm64 and x86_64 deps
        run: |
          tar -czvf macos_arm64_deps.tar.gz macos_arm64_deps
          tar -czvf macos_x86_64_deps.tar.gz macos_x86_64_deps

      - name: Upload deps
        uses: actions/upload-artifact@v4
        with:
          name: macos_x86_64_deps
          path: ./macos_x86_64_deps.tar.gz

      - name: Upload Release Asset for arm64
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./macos_arm64_deps.tar.gz
          asset_name: macos_arm64_deps.tar.gz
          tag: latest

      - name: Upload Release Asset for x86_64
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./macos_x86_64_deps.tar.gz
          asset_name: macos_x86_64_deps.tar.gz
          tag: latest
